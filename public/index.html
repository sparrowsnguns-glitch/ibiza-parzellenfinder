<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ibiza Parzellenfinder</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f6f7f9;--card:#fff;--accent:#0b63ff;--muted:#6b7280;--radius:14px;}
  *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{margin:0;background:var(--bg);color:#111}
  .wrap{max-width:1000px;margin:32px auto;padding:18px}
  .card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 8px 24px rgba(12,20,40,0.06)}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .logo{display:flex;align-items:center;gap:12px}
  .logoSquare{width:46px;height:46px;border-radius:12px;background:linear-gradient(135deg,#0b63ff,#48a3ff);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
  .title{font-weight:600}
  .langSwitch button{margin-left:8px;border-radius:10px;padding:6px 10px;border:1px solid #eaeefb;background:white}
  #loginBox {max-width:520px;margin:0 auto}
  input, button{width:100%;padding:11px;border-radius:10px;border:1px solid #e6e9ef}
  button.primary{background:var(--accent);color:white;border:none;font-weight:600}
  .grid{display:grid;grid-template-columns:1fr 380px;gap:14px;margin-top:14px}
  #map{height:520px;border-radius:12px}
  .right{display:flex;flex-direction:column;gap:10px}
  .linkBtn{display:inline-block;padding:10px;border-radius:10px;border:1px solid #eef6ff;background:white;color:var(--accent);text-decoration:none;font-weight:600}
  .parcelCard{padding:12px;border-radius:10px;background:#fbfdff;border:1px solid #eef6ff}
  .kv{display:flex;justify-content:space-between;padding:6px 0}
  pre.xml{background:#07102b;color:#dbeafe;padding:12px;border-radius:8px;max-height:220px;overflow:auto}
  .small{font-size:13px;color:var(--muted)}
  @media (max-width:980px){ .grid{grid-template-columns:1fr; } #map{height:360px} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <div class="logoSquare">IB</div>
      <div>
        <div class="title">Ibiza Parzellenfinder</div>
        <div class="small">Minimal • Legal • Fast</div>
      </div>
    </div>
    <div class="langSwitch">
      <button onclick="setLang('DE')">DE</button>
      <button onclick="setLang('EN')">EN</button>
    </div>
  </header>

  <div id="loginBox" class="card">
    <div style="margin-bottom:8px"><strong id="loginTitle">Login</strong><div class="small" id="loginText">Bitte einloggen</div></div>
    <input id="loginUser" placeholder="Benutzername" />
    <input id="loginPass" type="password" placeholder="Passwort" style="margin-top:8px" />
    <div style="display:flex;gap:10px;margin-top:10px">
      <button class="primary" onclick="login()">Login</button>
      <button onclick="fillDemo()">Demo</button>
    </div>
    <div class="small" style="margin-top:8px">Benutze Demo, um direkt zu testen.</div>
  </div>

  <div id="app" style="display:none">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div>
          <div style="font-weight:700" id="mainTitle">Ibiza Parzellen- & Eigentümerfinder</div>
          <div class="small" id="mainText">Klicke auf die Karte oder gib eine Referencia Catastral / Adresse ein</div>
        </div>
        <div style="min-width:260px">
          <div style="display:flex;gap:8px">
            <input id="searchInput" placeholder="Referencia Catastral oder Adresse" />
            <button class="primary" onclick="headerSearch()">Suchen</button>
          </div>
        </div>
      </div>
      <div class="grid" style="margin-top:12px">
        <div>
          <div id="map" style="height:520px"></div>
        </div>

        <aside class="right">
          <div class="parcelCard" id="infoCard">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong id="refDisplay">REF: —</strong><div class="small" id="munDisplay">—</div></div>
              <div><button onclick="resetAll()" class="linkBtn">Neue Suche</button></div>
            </div>
            <div class="kv"><div>Polígono / Parcela</div><div id="polyParcel">—</div></div>
            <div class="kv"><div>Fläche</div><div id="area">—</div></div>
            <div class="kv"><div>Nutzung</div><div id="usage">—</div></div>
            <div class="kv"><div>Inmuebles</div><div id="inmuebles">—</div></div>

            <div style="margin-top:8px">
              <a id="catastroLink" class="linkBtn" href="https://www.sedecatastro.gob.es/OVCInicio.aspx" target="_blank">Catastro öffnen</a>
              <a id="registroLink" class="linkBtn" href="https://sede.registradores.org/site/acceso" target="_blank" style="margin-left:6px">Registro</a>
            </div>

            <div style="margin-top:8px">
              <a id="streetViewLink" class="linkBtn" href="#" target="_blank">Street View</a>
            </div>

            <div style="margin-top:10px">
              <div style="font-weight:700">Weitere Daten</div>
              <div id="extraLinks" style="display:flex;gap:8px;margin-top:6px"></div>
            </div>
          </div>

          <div id="rawPanel" class="card" style="margin-top:12px;display:none">
            <div style="font-weight:700;margin-bottom:6px">Rohdaten (XML)</div>
            <pre id="xmlOut" class="xml"></pre>
            <a id="downloadXml" class="linkBtn" href="#" download="parcel.xml" style="margin-top:8px;display:inline-block">XML herunterladen</a>
          </div>
        </aside>
      </div>
    </div>
    <div style="text-align:center;margin-top:10px" class="small">Login: <strong>Nicole</strong> / Passwort: <strong>ichliebekatzen</strong></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  let lang='DE';
  function setLang(l){
    lang=l;
    document.getElementById('loginText').innerText = l==='DE' ? 'Bitte einloggen' : 'Please login';
    document.getElementById('mainText').innerText = l==='DE' ? 'Klicke auf die Karte oder gib eine Referencia Catastral / Adresse ein' : 'Click map or enter cadastral reference / address';
    document.getElementById('catastroLink').innerText = l==='DE' ? 'Catastro öffnen' : 'Open Catastro';
    document.getElementById('registroLink').innerText = l==='DE' ? 'Registro' : 'Registro';
    document.getElementById('streetViewLink').innerText = l==='DE' ? 'Street View' : 'Street View';
  }
  setLang('DE');

  function login(){
    const u=document.getElementById('loginUser').value.trim();
    const p=document.getElementById('loginPass').value.trim();
    if(u==='Nicole' && p==='ichliebekatzen'){
      document.getElementById('loginBox').style.display='none';
      document.getElementById('app').style.display='block';
      setTimeout(()=>map.invalidateSize(),150);
    } else alert(lang==='DE'?'Falsche Zugangsdaten':'Wrong credentials');
  }
  function fillDemo(){ document.getElementById('loginUser').value='Nicole'; document.getElementById('loginPass').value='ichliebekatzen'; }

  // init map
  const map = L.map('map').setView([38.9067,1.4206],12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
  let marker = null;

  function showSpinner(on){
    if(on){
      if(!document.getElementById('__spinner')){
        const s=document.createElement('div'); s.id='__spinner';
        s.style= 'position:fixed;right:18px;top:18px;padding:10px 14px;border-radius:10px;background:rgba(0,0,0,0.7);color:white;z-index:99999';
        s.innerText = lang==='DE' ? 'Lädt...' : 'Loading...';
        document.body.appendChild(s);
      } else document.getElementById('__spinner').style.display='block';
    } else if(document.getElementById('__spinner')) document.getElementById('__spinner').style.display='none';
  }

  // extract RC from XML text (best-effort)
  function extractRC(txt){
    try{
      const up = txt.toUpperCase();
      const m = up.match(/[0-9A-Z]{8,20}/g);
      if(m && m.length) return m[0];
    }catch(e){}
    return null;
  }

  // parse parcel xml (best effort)
  function parseParcelXml(txt){
    try {
      const doc = new DOMParser().parseFromString(txt,'text/xml');
      const g = (names)=>{
        for(const n of names){ const el = doc.getElementsByTagName(n)[0]; if(el && el.textContent) return el.textContent.trim(); }
        return null;
      };
      const ref = g(['REFCATASTRAL','RefCatastral','ReferenciaCatastral','REFERENCIA']);
      const muni = g(['MUNICIPIO','NOM_MUNICIPIO','NOMBRE']);
      const superf = g(['SUPERFICIE','SUPERF','AREA','SUPERFICIEHA']);
      const uso = g(['USO','TIPO_USO','DESCRIPCION_USO']);
      const pol = g(['POLIGONO','POL','NUMPOLIGONO']);
      const parcela = g(['PARCELA','PAR']);
      const inm = g(['INMUEBLE','NUM_INMUEBLES','NUMERO_INMUEBLES']);
      // find image urls
      const urls = txt.match(/https?:\/\/[^\s'">]+/gi) || [];
      let croquis=null, foto=null;
      urls.forEach(u=>{
        if(/croquis|cartografia|croqui|mapa/i.test(u)) croquis=u;
        if(/\.(jpg|jpeg|png|pdf)/i.test(u) && !foto) foto=u;
      });
      return { ref, muni, superf, uso, pol, parcela, inm, croquis, foto, raw:txt };
    } catch(e) { return { raw:txt }; }
  }

  async function loadParcelByRC(rc){
    showSpinner(true);
    try{
      const resp = await fetch(`/rc-info?rc=${encodeURIComponent(rc)}`);
      if(!resp.ok) throw new Error('rc-info failed');
      const txt = await resp.text();
      const data = parseParcelXml(txt);
      // fill UI
      document.getElementById('refDisplay').innerText = data.ref || rc;
      document.getElementById('munDisplay').innerText = data.muni || '';
      document.getElementById('polyParcel').innerText = `${data.pol || '—'} / ${data.parcela || '—'}`;
      document.getElementById('area').innerText = data.superf ? (data.superf + (data.superf.toString().includes('m') ? '' : ' m²')) : '—';
      document.getElementById('usage').innerText = data.uso || '—';
      document.getElementById('inmuebles').innerText = data.inm || '—';

      // set links
      if(data.croquis){ addExtraLink('Croquis', data.croquis); }
      else removeExtraLink('Croquis');
      if(data.foto){ addExtraLink('Fotos', data.foto); }
      else removeExtraLink('Fotos');

      // raw xml
      document.getElementById('xmlOut').innerText = data.raw || txt || '';
      document.getElementById('downloadXml').href = URL.createObjectURL(new Blob([data.raw || txt], {type:'application/xml'}));
      document.getElementById('rawPanel').style.display='block';
      // set street view search to RC fallback
      document.getElementById('streetViewLink').href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(data.ref || rc)}`;
      // set catastro link to inicio (user can paste RC on official page)
      document.getElementById('catastroLink').href = 'https://www.sedecatastro.gob.es/OVCInicio.aspx';
    } catch(err){
      console.error(err);
      alert(lang==='DE' ? 'Fehler beim Abrufen der Parzelleninfo' : 'Error fetching parcel info');
    } finally { showSpinner(false); }
  }

  function addExtraLink(title, href){
    let el = document.getElementById('link-'+title);
    if(!el){
      el = document.createElement('a');
      el.id = 'link-'+title;
      el.className = 'linkBtn';
      el.href = href;
      el.target = '_blank';
      el.innerText = title;
      document.getElementById('extraLinks').appendChild(el);
    } else { el.href = href; el.style.display='inline-block'; }
  }
  function removeExtraLink(title){ const el=document.getElementById('link-'+title); if(el) el.style.display='none'; }

  // Map click flow: coords -> rc -> parcel
  map.on('click', async function(e){
    const {lat, lng} = e.latlng;
    if(marker) map.removeLayer(marker);
    marker = L.marker([lat,lng]).addTo(map);
    // open street view (we will set exact pano later when we have coords)
    const siv = `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}&heading=0&pitch=0`;
    document.getElementById('streetViewLink').href = siv;
    // get RC via proxy
    showSpinner(true);
    try{
      const r = await fetch(`/coords-to-rc?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lng)}`);
      if(!r.ok) throw new Error('coords-to-rc failed');
      const txt = await r.text();
      const rc = extractRC(txt);
      if(!rc) { alert(lang==='DE'?'Referencia nicht gefunden':'Reference not found'); showSpinner(false); return; }
      document.getElementById('searchInput').value = rc;
      await loadParcelByRC(rc);
      // open Street View automatically
      window.open(siv,'_blank');
    } catch(e){
      console.error(e);
      alert(lang==='DE'?'Fehler beim Ermitteln der Referencia':'Error finding reference');
    } finally { showSpinner(false); }
  });

  // Header search: if looks like RC -> load, else geocode via Nominatim -> coords -> rc
  function looksLikeRC(v){ return /[0-9A-Z]{8,20}/i.test(v); }

  async function headerSearch(){
    const v=document.getElementById('searchInput').value.trim();
    if(!v) return;
    if(looksLikeRC(v)){
      await loadParcelByRC(v.toUpperCase());
      return;
    }
    // address: geocode with nominatim
    try{
      showSpinner(true);
      const g = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(v)}&limit=1`);
      const j = await g.json();
      if(!j || !j.length){ alert(lang==='DE'?'Adresse nicht gefunden':'Address not found'); return; }
      const lat=j[0].lat, lon=j[0].lon;
      map.setView([lat,lon],17);
      if(marker) map.removeLayer(marker);
      marker = L.marker([lat,lon]).addTo(map);
      // call coords-to-rc
      const r = await fetch(`/coords-to-rc?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`);
      const txt = await r.text();
      const rc = extractRC(txt);
      if(!rc){ alert(lang==='DE'?'Referencia nicht gefunden':'Reference not found'); return; }
      document.getElementById('searchInput').value = rc;
      await loadParcelByRC(rc);
      window.open(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lon}&heading=0&pitch=0}`,'_blank');
    } catch(e){
      console.error(e);
      alert(lang==='DE'?'Fehler bei Suche':'Search error');
    } finally{ showSpinner(false); }
  }

  function resetAll(){
    document.getElementById('searchInput').value='';
    document.getElementById('refDisplay').innerText='REF: —';
    document.getElementById('polyParcel').innerText='—';
    document.getElementById('area').innerText='—';
    document.getElementById('usage').innerText='—';
    document.getElementById('inmuebles').innerText='—';
    document.getElementById('xmlOut').innerText='';
    document.getElementById('rawPanel').style.display='none';
    document.getElementById('extraLinks').innerHTML='';
    if(marker){ map.removeLayer(marker); marker=null; }
  }
</script>
</body>
</html>
